# SafeTrip Project Development Rules

## Project Overview
SafeTripì€ YOLOv11 ê¸°ë°˜ì˜ ë‹¤ì¤‘ ìž‘ì—… ì»´í“¨í„° ë¹„ì „ ëª¨ë¸ì„ ê°œë°œí•˜ì—¬ ìžìœ¨ì£¼í–‰ ì°¨ëŸ‰ì˜ ì•ˆì „ì„±ì„ í–¥ìƒì‹œí‚¤ëŠ” í”„ë¡œì íŠ¸ìž…ë‹ˆë‹¤.

## Core Technologies

### Framework & Libraries
- **Base Model**: YOLOv11 (Ultralytics ìµœì‹  ë²„ì „)
- **Deep Learning**: PyTorch 2.0+
- **Computer Vision**: OpenCV, Ultralytics
- **Optimization**: TensorRT for Jetson deployment
- **Monitoring**: Weights & Biases, TensorBoard

### Multi-Task Architecture
1. **Object Detection**: 32ê°œ í´ëž˜ìŠ¤ (person, car, pole, traffic_sign ë“±)
2. **Instance Segmentation**: 6ê°œ surface í´ëž˜ìŠ¤ (alley, sidewalk, roadway ë“±)  
3. **Depth Estimation**: ìŠ¤í…Œë ˆì˜¤ ë¹„ì „ ê¸°ë°˜ ê¹Šì´ ì¶”ì •

## Data Structure & Handling

### Dataset Organization
```
data/
â”œâ”€â”€ bbox/           # Object detection (50 folders, ~14,642 images)
â”œâ”€â”€ surface/        # Segmentation (130 folders, ~9,556 images)
â””â”€â”€ depth/          # Depth estimation (5 folders, ~19,721 images)
```

### Annotation Formats
- **BBox**: CVAT XML í˜•ì‹, ë‹¤ì¤‘ ê°ì²´ ë°”ìš´ë”© ë°•ìŠ¤
- **Surface**: Polygon ì¢Œí‘œ, ë„ë¡œ í‘œë©´ segmentation
- **Depth**: ìŠ¤í…Œë ˆì˜¤ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ íŒŒì¼ (.conf)

### Data Processing Rules
- Partial labeling ì§€ì› (ì¼ë¶€ íƒœìŠ¤í¬ë§Œ ë¼ë²¨ëœ ë°ì´í„° í—ˆìš©)
- íƒœìŠ¤í¬ë³„ ë°ì´í„° ë°¸ëŸ°ì‹± (Detection:Segmentation:Depth = 40:30:30)
- Missing annotation ì²˜ë¦¬ ë¡œì§ í¬í•¨

## Model Development Guidelines

### Architecture Principles
- YOLOv11 ê¸°ë°˜ í†µí•© ì•„í‚¤í…ì²˜
- Shared backbone and neck for efficiency
- Task-specific heads for specialized outputs
- Feature reuse ìµœëŒ€í™”ë¡œ ë©”ëª¨ë¦¬ íš¨ìœ¨ì„± í™•ë³´

### Training Strategy
```python
# Phase 1: Head-only training (1-30 epochs)
# - Freeze backbone weights
# - Train custom heads only
# - Higher learning rates

# Phase 2: End-to-end training (31-100 epochs) 
# - Unfreeze all parameters
# - Lower learning rates
# - Fine-tuning entire model
```

### Loss Function Design
- Dynamic loss weighting (Kendall et al. uncertainty method)
- Task-aware masking for partial labels
- BerHu loss for depth estimation
- Balanced loss weights based on data distribution

## Performance Requirements

### Target Metrics
- **Detection**: mAP@0.5 > 0.7, mAP@0.5:0.95 > 0.5
- **Segmentation**: Mask mAP@0.5 > 0.65, mAP@0.5:0.95 > 0.45  
- **Depth**: AbsRel < 0.15, RMSE < 5.0m, Î´1 > 0.85

### Deployment Targets
- **Platform**: NVIDIA Jetson Orin Nano
- **Performance**: 30+ FPS at 640x640 resolution
- **Memory**: <6GB GPU memory usage
- **Power**: <15W power consumption

## Code Organization

### Directory Structure
```
safetrip/
â”œâ”€â”€ data/                   # Dataset and parsers
â”œâ”€â”€ models/                 # Model implementations
â”œâ”€â”€ mediazen/evaluation/    # Evaluation scripts
â”œâ”€â”€ visualizations/         # Output visualizations
â”œâ”€â”€ docs/                   # Documentation
â””â”€â”€ .cursor/rules/          # Development rules
```

### File Naming Conventions
- Model files: `safetrip_yolo_multitask.py`
- Training scripts: `train_multitask.py`
- Evaluation: Place in `mediazen/evaluation/` folder
- Configuration: YAML files for dataset and model configs

### Code Quality Standards
- Type hints for all function parameters
- Comprehensive error handling with try-except blocks
- Memory-efficient implementations
- Proper tensor dimension validation

## Development Workflow

### Phase-based Development
1. **Phase 1**: âœ… Base model architecture design
2. **Phase 2**: ðŸ”„ Advanced training techniques implementation
3. **Phase 3**: ðŸ“‹ TensorRT optimization and deployment

### Current Implementation Status
- âœ… Multi-task model architecture
- âœ… Custom depth head implementation  
- âœ… Basic training pipeline
- ðŸ”„ Balanced batch sampling
- ðŸ”„ Dynamic loss weighting
- ðŸ“‹ TensorRT optimization

### Testing & Validation
- Unit tests for data loaders and model components
- Integration tests for training pipeline
- Performance benchmarking on Jetson hardware
- Real-world scenario validation

## Optimization Guidelines

### Memory Optimization
- Shared feature extraction across tasks
- Efficient tensor operations
- Gradient checkpointing if needed
- Proper CUDA memory management

### Inference Optimization
- TensorRT engine building with FP16/INT8 precision
- Input/output pipeline optimization
- Batch processing for multiple frames
- Post-processing acceleration

### Model Compression
- Knowledge distillation from larger models
- Pruning and quantization techniques
- Architecture optimization for mobile deployment

## Monitoring & Evaluation

### Training Monitoring
- Task-specific loss tracking
- Performance metrics per epoch
- Learning rate scheduling
- Gradient norm monitoring

### Model Evaluation
- Comprehensive metric calculation per task
- Cross-validation on different scenarios
- Real-time performance measurement
- Memory and power consumption tracking

### Logging Standards
- Structured logging with proper levels
- Experiment tracking with Weights & Biases
- Model checkpointing with best performance
- Detailed error reporting and debugging info

## Collaboration Guidelines

### Code Review Process
- Multi-task model changes require review
- Performance critical sections need benchmarking
- Memory usage validation for Jetson compatibility
- Documentation updates for new features

### Documentation Requirements
- Algorithm descriptions with mathematical formulations
- Performance benchmark results
- Deployment instructions for different platforms
- Troubleshooting guides for common issues

### Version Control
- Feature branches for major model changes
- Semantic versioning for model releases
- Tagged releases for deployment milestones
- Proper commit messages with scope indication

This comprehensive ruleset ensures consistent development practices while maintaining the multi-task nature and deployment requirements of the SafeTrip project.
